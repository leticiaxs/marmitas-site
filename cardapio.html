<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Pedido de Marmitas</title>
  <style>
    body{font-family:Arial;background:#f6f6f6;margin:0;padding:24px}
    .card{max-width:980px;margin:auto;background:#fff;border-radius:14px;padding:20px;box-shadow:0 10px 22px rgba(0,0,0,.08)}
    input,textarea,select{width:100%;padding:10px;border:1px solid #ddd;border-radius:12px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    label{display:block;margin:10px 0 6px;font-size:14px}
    .hint{color:#666;font-size:13px;margin:10px 0 14px}
    .tools{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
    .tools > div{flex:1;min-width:220px}
    .item{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:12px;border:1px solid #eee;border-radius:12px;margin:10px 0}
    .name{font-weight:700}
    .meta{font-size:12px;color:#666;margin-top:4px}
    .qtyBox{display:flex;align-items:center;gap:8px}
    .qty{width:110px}
    .btn{padding:12px;border:0;border-radius:12px;background:#111;color:#fff;font-size:16px;cursor:pointer}
    .btn.secondary{background:#333}
    .topline{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .pill{padding:8px 10px;border-radius:999px;background:#f1f1f1;font-weight:700}
    .status{margin-top:10px;font-size:14px}
    .ok{color:#16a34a}
    .err{color:#dc2626}
    .sep{height:1px;background:#eee;margin:14px 0}
  </style>
</head>
<body>
  <div class="card">
    <div class="topline">
      <h2 style="margin:0">üç± Pedido de Marmitas Congeladas</h2>
      <div class="pill">
        Total itens: <span id="totalItens">0</span>
        <span id="totalReaisWrap" style="display:none"> ‚Ä¢ R$ <span id="totalReais">0,00</span></span>
      </div>
    </div>

    <div class="hint">
      Selecione as quantidades e envie. O pedido ser√° gravado automaticamente na planilha.
    </div>

    <div class="row">
      <div style="flex:1;min-width:260px">
        <label>Nome completo*</label>
        <input id="nome" autocomplete="name" />
      </div>
      <div style="flex:1;min-width:260px">
        <label>WhatsApp*</label>
        <input id="whatsapp" autocomplete="tel" />
      </div>
    </div>

    <label>Observa√ß√µes</label>
    <textarea id="obs" rows="4" placeholder="Ex.: sem cebola, sem pimenta..."></textarea>

    <div class="sep"></div>

    <div class="tools">
      <div>
        <label>Buscar</label>
        <input id="busca" placeholder="Digite para filtrar..." />
      </div>
      <div>
        <label>Categoria</label>
        <select id="categoria"></select>
      </div>
    </div>

    <h3 style="margin-top:16px">Card√°pio</h3>
    <div id="loading" class="hint">Carregando card√°pio...</div>
    <div id="lista"></div>

    <button class="btn" id="enviar">Enviar pedido</button>
    <button class="btn secondary" id="limpar" style="margin-top:10px">Novo pedido</button>

    <div id="status" class="status"></div>
  </div>

<script>
  // ‚úÖ BACKEND
  const API_BASE = "https://marmitas-api.onrender.com";
  const API_URL  = API_BASE + "/api/pedido";
  const MENU_URL = API_BASE + "/api/menu";
  const API_KEY  = "marmita2026"; // mesma do Render

  // ‚úÖ Se quiser somar R$ no topo, deixe true e cadastre preco na planilha Marmitas.
  const MOSTRAR_TOTAL_REAIS = true;

  // Estado
  let menu = [];            // itens do backend
  let quant = {};           // { nome: qtd }
  let categorias = ["Todas"];

  const listaEl = document.getElementById("lista");
  const loadingEl = document.getElementById("loading");
  const catEl = document.getElementById("categoria");
  const buscaEl = document.getElementById("busca");
  const totalItensEl = document.getElementById("totalItens");
  const totalReaisWrap = document.getElementById("totalReaisWrap");
  const totalReaisEl = document.getElementById("totalReais");
  const statusEl = document.getElementById("status");

  function setStatus(msg, cls){
    statusEl.className = "status " + (cls || "");
    statusEl.textContent = msg || "";
  }

  function totalItens(){
    return Object.values(quant).reduce((a,b)=>a+(b||0),0);
  }

  function totalReais(){
    let t = 0;
    for(const it of menu){
      const q = quant[it.nome] || 0;
      t += q * (Number(it.preco) || 0);
    }
    return t;
  }

  function fmtBRL(v){
    return (v || 0).toLocaleString("pt-BR", {minimumFractionDigits:2, maximumFractionDigits:2});
  }

  function updateTotals(){
    totalItensEl.textContent = totalItens();
    if(MOSTRAR_TOTAL_REAIS){
      totalReaisWrap.style.display = "inline";
      totalReaisEl.textContent = fmtBRL(totalReais());
    }
  }

  function renderCategorias(){
    catEl.innerHTML = categorias.map(c => `<option value="${c}">${c}</option>`).join("");
  }

  function renderLista(){
    const q = (buscaEl.value || "").trim().toLowerCase();
    const cat = catEl.value || "Todas";

    const filtered = menu.filter(it => {
      const okCat = (cat === "Todas") ? true : (it.categoria === cat);
      const okSearch = q ? it.nome.toLowerCase().includes(q) : true;
      return okCat && okSearch;
    });

    listaEl.innerHTML = filtered.map((it, i) => {
      const v = quant[it.nome] || 0;
      const preco = Number(it.preco) || 0;
      const meta = (it.categoria || "") + (preco ? ` ‚Ä¢ R$ ${fmtBRL(preco)}` : "");
      return `
        <div class="item">
          <div>
            <div class="name">${it.nome}</div>
            <div class="meta">${meta}</div>
          </div>
          <div class="qtyBox">
            <div style="font-size:12px;color:#666">Qtd</div>
            <input class="qty" type="number" min="0" value="${v}" data-nome="${escapeHtml(it.nome)}">
          </div>
        </div>
      `;
    }).join("");

    // Bind inputs
    listaEl.querySelectorAll('input.qty').forEach(inp => {
      inp.addEventListener("input", () => {
        const nome = unescapeHtml(inp.getAttribute("data-nome") || "");
        const v = Math.max(0, parseInt(inp.value || "0", 10) || 0);
        quant[nome] = v;
        updateTotals();
      });
    });

    updateTotals();
  }

  // Util simples para armazenar nome no atributo sem quebrar HTML
  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function unescapeHtml(str){
    const t = document.createElement("textarea");
    t.innerHTML = str;
    return t.value;
  }

  async function carregarMenu(){
    loadingEl.style.display = "block";
    listaEl.innerHTML = "";
    setStatus("", "");
    try{
      const r = await fetch(MENU_URL);
      const data = await r.json();
      if(!data.ok) throw new Error("Falha ao carregar menu");

      menu = data.itens || [];
      quant = Object.fromEntries(menu.map(it => [it.nome, 0]));

      const cats = Array.from(new Set(menu.map(i => i.categoria).filter(Boolean)));
      categorias = ["Todas", ...cats];
      renderCategorias();

      loadingEl.style.display = "none";
      renderLista();
    }catch(e){
      loadingEl.style.display = "none";
      setStatus("‚ùå N√£o foi poss√≠vel carregar o card√°pio. Verifique a API.", "err");
      console.error(e);
    }
  }

  buscaEl.addEventListener("input", renderLista);
  catEl.addEventListener("change", renderLista);

  document.getElementById("limpar").addEventListener("click", () => {
    document.getElementById("nome").value = "";
    document.getElementById("whatsapp").value = "";
    document.getElementById("obs").value = "";
    buscaEl.value = "";
    catEl.value = "Todas";
    for(const k in quant) quant[k] = 0;
    renderLista();
    setStatus("", "");
  });

  document.getElementById("enviar").addEventListener("click", async () => {
    const nome = document.getElementById("nome").value.trim();
    const whatsapp = document.getElementById("whatsapp").value.trim();
    const obs = document.getElementById("obs").value.trim();

    if(!nome || !whatsapp){
      setStatus("‚ö†Ô∏è Preencha Nome e WhatsApp.", "err");
      return;
    }

    const total = totalItens();
    if(total <= 0){
      setStatus("‚ö†Ô∏è Selecione pelo menos 1 marmita.", "err");
      return;
    }

    // Formato que o backend espera: { nome, whatsapp, obs, quantidades: { "Nome": qtd } }
    const quantidades = {};
    for(const [k,v] of Object.entries(quant)){
      if((v||0) > 0) quantidades[k] = v;
    }

    try{
      setStatus("Enviando...", "");
      const r = await fetch(API_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-API-KEY": API_KEY
        },
        body: JSON.stringify({ nome, whatsapp, obs, quantidades })
      });

      const text = await r.text();
      if(!r.ok) throw new Error(`HTTP ${r.status} - ${text}`);

      let data = {};
      try{ data = JSON.parse(text); }catch{}

      setStatus(`‚úÖ Pedido enviado! Total: ${data.total ?? total}`, "ok");
    }catch(e){
      console.error(e);
      setStatus(`‚ùå Erro ao enviar: ${e.message}`, "err");
    }
  });

  // Start
  carregarMenu();
</script>
</body>
</html>
